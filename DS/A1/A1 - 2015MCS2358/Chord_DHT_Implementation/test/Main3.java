package test;

import java.io.PrintStream;
import java.net.InetAddress;
import java.net.URL;

import implementation.Chord;
import implementation.ChordException;
import implementation.HashFunc;
import implementation.Node;

/**
 * Evaluate the number of packets generated by lookup operation
 * 
 * @author joonion
 * 
 */
public class Main3 {

	//public static final String HASH_FUNCTION = "SHA-1";

	//public static final int KEY_LENGTH = 160;

	public static final int NUM_OF_NODES = 8192;

	public static int counter = 0;

	public static void main(String[] args) throws Exception {

		PrintStream out = System.out;

//		out = new PrintStream("result.log");

		long start = System.currentTimeMillis();

		String host = InetAddress.getLocalHost().getHostAddress();
		int port = 9000;

//		Hash.setFunction(HASH_FUNCTION);
	//	Hash.setKeyLength(KEY_LENGTH);

		Chord chord = new Chord();
		for (int i = 0; i < NUM_OF_NODES; i++) {
			URL url = new URL("http", host, port + i, "");
			try {
				chord.createNode(url.toString());
			} catch (ChordException e) {
				e.printStackTrace();
				System.exit(0);
			}
		}
		out.println(NUM_OF_NODES + " nodes are created.");

		for (int i = 0; i < NUM_OF_NODES; i++) {
			Node node = chord.getSortedNode(i);
			out.println(node);
		}

		for (int i = 1; i < NUM_OF_NODES; i++) {
			Node node = chord.getNode(i);
			node.join(chord.getNode(0));
			Node preceding = node.getSuccessor().getPredecessor();
			node.stabilize();
			if (preceding == null) {
				node.getSuccessor().stabilize();
			} else {
				preceding.stabilize();
			}
		}
		out.println("Chord ring is established.");

		for (int i = 0; i < NUM_OF_NODES; i++) {
			Node node = chord.getNode(i);
			node.fixFingers();
		}
		out.println("Finger Tables are fixed.");

//		for (int i = 0; i < NUM_OF_NODES; i++) {
//			ChordNode node = chord.getSortedNode(i);
//			node.printFingerTable(out);
//		}

		// lookup all the nodes from each node
		for (int i = 0; i < NUM_OF_NODES; i++) {
			Node node = chord.getSortedNode(i);
			out.println("Lookup from: " + node);
			int totalCount = 0;
			int maxCount = 0;
			for (int j = 0; j < NUM_OF_NODES; j++) {
				Node targetNode = chord.getSortedNode(j);
				Main3.counter = 0;
				node.findSuccessor(targetNode.getNodeKey());
//				out.println("\t" + counter + ": " + targetNode.getNodeKey());
				totalCount += Main3.counter;
				if (maxCount < Main3.counter) {
					maxCount = Main3.counter;
				}
					
			}
			out.println("Avg.: " + (double)(totalCount/NUM_OF_NODES) + ",Max: " + maxCount);
		}
		
		long end = System.currentTimeMillis();

		int interval = (int) (end - start);
		System.out.printf("Elapsed Time : %d.%d", interval / 1000,
				interval % 1000);
	}
}
