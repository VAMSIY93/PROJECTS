W = zeros(8,4);
W(1,:)=[38,76,0,1];
W(2,:)=[190,38,0,1];
W(3,:)=[76,152,0,1];
W(4,:)=[304,114,0,1];
W(5,:)=[266,190,0,1];
W(6,:)=[114,114,0,1];
W(7,:)=[266,76,0,1];
W(8,:)=[152,152,0,1];


C = zeros(8,2);
C(1,:)=[678,429];
C(2,:)=[1138,309];
C(3,:)=[806,663];
C(4,:)=[1464,524];
C(5,:)=[1369,748];
C(6,:)=[992,542];
C(7,:)=[1358,417];
C(8,:)=[1038,652];

A = zeros(6,8);
for i=1:6
    A(i,:)=[C(i,1)*W(i,:),-C(i,2)*W(i,:)];
end

[U,D,V] = svd(A,0);
v1 = V(:,end);
gamma = sqrt(sum(v1(1:3,1).^2));
alpha = sqrt(sum(v1(5:7,1).^2))/gamma;

R = zeros(3);
T = zeros(3,1);
O = zeros(1,3);
%Extr = [Extr;]
R(2,:) = (v1(1:3,1)/gamma)';
R(1,:) = (v1(5:7,1)/(alpha*gamma))';
T(2,1) = v1(4,1)/gamma;
T(1,1) = v1(8,1)/(alpha*gamma);
R(3,:) = cross(R(1,:),R(2,:));

[U1,D1,V1] = svd(R);
R = U1*V1';

Extr = [R,T;O,1];

res = sum(Extr(1,:).*W(3,:));
if res>0
    Extr(1,:) = -1*Extr(1,:);
    R(1,:) = -1*R(1,:);
    T(1,1) = -1*T(1,1);
end

res = sum(Extr(2,:).*W(3,:));
if res>0
    Extr(2,:) = -1*Extr(2,:);
    R(2,:) = -1*R(2,:);
    T(2,1) = -1*T(2,1);
end

A = zeros(6,2);
B = zeros(6,1);
for i=1:6
    A(i,1) = C(i,1);
    A(i,2) = sum(Extr(1,:).*W(i,:));
    B(i,1) = C(i,1)*(sum(R(3,:).*W(i,1:3))+T(1,1));
end

res = inv(A'*A)*A'*B;
T(3,1) = res(1,1);
Extr(3,4) = res(1,1);
fx = res(2,1);
fy = fx/alpha;